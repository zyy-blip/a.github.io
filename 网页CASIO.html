<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LaTeX 专业绘图计算器</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/aaaakshat/cm-web-fonts@latest/fonts.css">

    <style>
        :root {
            --bg-color: #f0f3f6;
            --calc-bg: #ffffff;
            --screen-bg: #fdfdfd;
            --btn-primary: #4a90e2;
            --btn-danger: #f56c6c;
            --text-main: #2c3e50;
            --color-fx: #0984e3;
            --color-gx: #e17055;
            --math-font: 'Computer Modern Serif', serif;
        }

        body {
            background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; font-family: var(--math-font);
        }

        .calculator {
            background-color: var(--calc-bg); width: 440px; height: 920px;
            border-radius: 30px; box-shadow: 0 40px 80px rgba(0,0,0,0.15);
            padding: 24px; box-sizing: border-box; display: flex; flex-direction: column; gap: 14px;
        }

        /* 顶部导航 */
        .top-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .nav-btn {
            border: 1px solid #e0e6ed; background-color: #f8fafc;
            color: var(--text-main); border-radius: 12px; height: 44px;
            font-size: 16px; font-family: var(--math-font); font-weight: 800;
            cursor: pointer; transition: 0.2s;
        }
        .nav-btn.active { background-color: var(--btn-primary); color: white; border-color: var(--btn-primary); }

        /* 屏幕显示 */
        .screen {
            background-color: var(--screen-bg); border-radius: 18px;
            border: 1px solid #dcdfe6; padding: 18px; display: flex; flex-direction: column;
            justify-content: center; min-height: 140px;
        }

        /* 双行 LaTeX 容器 */
        .plot-info-area { display: none; flex-direction: column; gap: 10px; overflow: hidden; }
        .latex-line {
            width: 100%; overflow-x: auto; white-space: nowrap;
            font-size: 20px; padding-bottom: 4px; border-bottom: 1px solid #f0f0f0;
        }
        /* 自定义滚动条 */
        .latex-line::-webkit-scrollbar { height: 3px; }
        .latex-line::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }

        /* 键盘区按钮优化 */
        .keyboard { flex: 1; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        button {
            border: 1px solid #eaedf0; border-radius: 14px; background-color: #fff;
            cursor: pointer; transition: all 0.1s; font-family: var(--math-font);
            font-size: 22px; font-weight: 700; color: #1a1a1a;
        }
        button:active { transform: scale(0.92); background-color: #f0f0f0; }

        /* f(x) g(x) 按钮加粗及斜体优化 */
        .btn-func {
            color: var(--btn-primary); font-style: italic; font-weight: 800; font-size: 24px;
        }
        .btn-calc { background-color: var(--btn-primary); color: white; font-size: 28px; border: none; }
        .btn-danger { background-color: var(--btn-danger); color: white; border: none; }

        /* 绘图容器 */
        .graph-area { flex: 1; display: none; flex-direction: column; gap: 12px; min-height: 0; }
        .canvas-container { flex: 1; background: white; border: 1px solid #dcdfe6; border-radius: 16px; position: relative; cursor: move; overflow: hidden; touch-action: none;}
        canvas { width: 100%; height: 100%; position: absolute; }

        /* 四宫格边界控制面板 */
        .boundary-grid {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
            gap: 8px; background: #f1f3f4; padding: 12px; border-radius: 16px;
        }
        .boundary-item {
            display: flex; align-items: center; justify-content: space-between;
            background: white; padding: 6px 12px; border-radius: 8px; border: 1px solid #e0e6ed;
        }
        .boundary-item span { font-size: 13px; font-weight: 800; color: #666; width: 45px; }
        .boundary-item input {
            width: 100%; border: none; outline: none; text-align: right;
            font-family: var(--math-font); font-size: 16px; font-weight: 700;
        }

        /* 求根结果显示 */
        .root-results {
            flex: 1; overflow-y: auto; background: white; border-radius: 16px;
            padding: 15px; border: 1px solid #ddd;
        }
        .root-katex-item { padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 20px; }
    </style>
</head>
<body>

<div class="calculator">
    <div class="top-nav">
        <button id="nav-fx" class="nav-btn" onclick="switchMode('fx')">f(x)</button>
        <button id="nav-gx" class="nav-btn" onclick="switchMode('gx')">g(x)</button>
        <button id="nav-main" class="nav-btn active" onclick="switchMode('main')">计算</button>
        <button id="nav-plot" class="nav-btn" onclick="switchMode('plot')">绘图</button>
        <button id="nav-roots" class="nav-btn" onclick="switchMode('roots')">求根</button>
    </div>

    <div class="screen" id="main-screen">
        <div id="single-line-display" style="font-size: 24px; width: 100%; overflow-x: auto;"></div>
        <div class="plot-info-area" id="double-line-display">
            <div class="latex-line" id="line-fx"></div>
            <div class="latex-line" id="line-gx"></div>
        </div>
        <div id="calc-res-val" style="text-align: right; font-weight: 800; font-size: 24px; margin-top: 10px;">0</div>
    </div>

    <div style="display:none; flex-direction:column; gap:10px;" id="roots-panel">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="nav-btn active" id="root-target-f" onclick="setRootTarget('f')">针对 f(x)</button>
            <button class="nav-btn" id="root-target-g" onclick="setRootTarget('g')">针对 g(x)</button>
        </div>
        <div class="boundary-grid" style="grid-template-rows: 1fr;">
            <div class="boundary-item"><span>Start</span><input type="number" id="rootX1" value="-10"></div>
            <div class="boundary-item"><span>End</span><input type="number" id="rootX2" value="10"></div>
        </div>
        <button class="btn-calc" style="font-size: 20px; padding: 10px;" onclick="calculateRoots()">执行求根</button>
        <div class="root-results" id="root-list"></div>
    </div>

    <div class="graph-area" id="graph-area">
        <div class="canvas-container" id="canvas-wrap"><canvas id="plotCanvas"></canvas></div>
        <div class="boundary-grid">
            <div class="boundary-item"><span>X Min</span><input type="number" id="xMin" value="-10" step="any" onchange="syncFromInput()"></div>
            <div class="boundary-item"><span>X Max</span><input type="number" id="xMax" value="10" step="any" onchange="syncFromInput()"></div>
            <div class="boundary-item"><span>Y Min</span><input type="number" id="yMin" value="-6" step="any" onchange="syncFromInput()"></div>
            <div class="boundary-item"><span>Y Max</span><input type="number" id="yMax" value="6" step="any" onchange="syncFromInput()"></div>
        </div>
    </div>

    <div class="keyboard" id="keyboard-area">
        <button class="btn-func" onclick="append('f(x)')">f(x)</button>
        <button class="btn-func" onclick="append('g(x)')">g(x)</button>
        <button onclick="append('int(')">∫</button><button onclick="append('deriv(')">d/dx</button><button onclick="append('x')">x</button>
        <button onclick="append('sqrt(')">√</button><button onclick="append('^2')">x²</button><button onclick="append('^')">xⁿ</button><button onclick="append('log10(')">log</button><button onclick="append('log(')">ln</button>
        <button onclick="append('sin(')">sin</button><button onclick="append('cos(')">cos</button><button onclick="append('tan(')">tan</button><button onclick="append('pi')">π</button><button onclick="append('e')">e</button>
        <button onclick="append('(')">(</button><button onclick="append(')')">)</button><button onclick="append(',')">,</button><button class="btn-danger" onclick="deleteLast()">DEL</button><button class="btn-danger" onclick="clearAll()">AC</button>
        <button onclick="append('7')">7</button><button onclick="append('8')">8</button><button onclick="append('9')">9</button><button onclick="append('*')">×</button><button onclick="append('/')">÷</button>
        <button onclick="append('4')">4</button><button onclick="append('5')">5</button><button onclick="append('6')">6</button><button onclick="append('+')">+</button><button onclick="append('-')">-</button>
        <button onclick="append('1')">1</button><button onclick="append('2')">2</button><button onclick="append('3')">3</button><button onclick="append('Ans')">Ans</button><button class="btn-calc" onclick="calculate()">=</button>
        <button style="grid-column: span 2" onclick="append('0')">0</button><button onclick="append('.')">.</button><button style="grid-column: span 2" onclick="append('*10^')">EXP</button>
    </div>
</div>

<script>
    let state = { mode: 'main', expr: { main: '', fx: '', gx: '' }, rootTarget: 'f' };
    let lastAnswer = '0', currentExpression = '';
    let config = { xMin: -10, xMax: 10, yMin: -6, yMax: 6 };
    let isDragging = false, lastMousePos = { x: 0, y: 0 };

    const singleDisplay = document.getElementById('single-line-display');
    const doubleDisplay = document.getElementById('double-line-display');
    const resVal = document.getElementById('calc-res-val');
    const canvas = document.getElementById('plotCanvas');
    const ctx = canvas.getContext('2d');

    function switchMode(m) {
        state.expr[state.mode] = currentExpression;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + m).classList.add('active');

        state.mode = m;
        currentExpression = state.expr[m] || "";

        // UI 逻辑
        const isPlot = (m === 'plot');
        const isRoot = (m === 'roots');

        document.getElementById('keyboard-area').style.display = (isPlot || isRoot) ? 'none' : 'grid';
        document.getElementById('graph-area').style.display = isPlot ? 'flex' : 'none';
        document.getElementById('roots-panel').style.display = isRoot ? 'flex' : 'none';

        // 屏幕切换
        if (isPlot) {
            singleDisplay.style.display = 'none';
            doubleDisplay.style.display = 'flex';
            resVal.style.display = 'none';
            updatePlotScreen();
            setTimeout(() => { initCanvas(); drawGraph(); }, 50);
        } else if (isRoot) {
            document.getElementById('main-screen').style.display = 'none';
        } else {
            document.getElementById('main-screen').style.display = 'flex';
            singleDisplay.style.display = 'block';
            doubleDisplay.style.display = 'none';
            resVal.style.display = 'block';
            resVal.innerText = (m === 'main' ? "= " + lastAnswer : m + " 模式");
            renderLatex();
        }
    }

    function updatePlotScreen() {
        const render = (id, label, exp) => {
            let tex = "";
            try { tex = exp ? math.parse(exp).toTex() : ""; } catch(e) { tex = exp; }
            katex.render(`${label} = ${tex}`, document.getElementById(id), { throwOnError: false });
        };
        render('line-fx', 'f(x)', state.expr.fx);
        render('line-gx', 'g(x)', state.expr.gx);
    }

    function setRootTarget(t) {
        state.rootTarget = t;
        document.getElementById('root-target-f').classList.toggle('active', t === 'f');
        document.getElementById('root-target-g').classList.toggle('active', t === 'g');
    }

    // --- 求根：带编号及 LaTeX ---
    function calculateRoots() {
        const x1 = parseFloat(document.getElementById('rootX1').value);
        const x2 = parseFloat(document.getElementById('rootX2').value);
        const exp = state.expr[state.rootTarget === 'f' ? 'fx' : 'gx'];
        const listEl = document.getElementById('root-list');
        listEl.innerHTML = "";

        if (!exp) { listEl.innerText = "函数未定义"; return; }

        try {
            const scope = getCombinedScope();
            const compiled = math.compile(exp);
            const f = (v) => compiled.evaluate({x: v, ...scope});
            let roots = [];
            const steps = 400;
            const delta = (x2 - x1) / steps;

            for (let i = 0; i < steps; i++) {
                let a = x1 + i * delta, b = a + delta;
                if (f(a) * f(b) <= 0) {
                    let r = bisection(f, a, b);
                    if (r !== null) roots.push(r.toFixed(6));
                }
            }
            roots = [...new Set(roots)].sort((a,b) => a-b);

            roots.forEach((r, idx) => {
                const div = document.createElement('div');
                div.className = "root-katex-item";
                listEl.appendChild(div);
                katex.render(`x_{${idx + 1}} = ${r}`, div);
            });
            if (!roots.length) listEl.innerText = "未发现实根";
        } catch(e) { listEl.innerText = "计算出错"; }
    }

    function bisection(f, a, b) {
        for (let i = 0; i < 40; i++) {
            let m = (a + b) / 2;
            if (f(a) * f(m) <= 0) b = m; else a = m;
        }
        return (a + b) / 2;
    }

    // --- 绘图引擎核心 ---
    function initCanvas() {
        const wrap = document.getElementById('canvas-wrap');
        const dpr = window.devicePixelRatio || 1;
        canvas.width = wrap.clientWidth * dpr; canvas.height = wrap.clientHeight * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function drawGraph() {
        const w = canvas.width / window.devicePixelRatio, h = canvas.height / window.devicePixelRatio;
        ctx.clearRect(0, 0, w, h);
        const mX = (x) => ((x - config.xMin) / (config.xMax - config.xMin)) * w;
        const mY = (y) => h - ((y - config.yMin) / (config.yMax - config.yMin)) * h;

        // 坐标轴
        ctx.strokeStyle = '#f0f0f0'; ctx.lineWidth = 1; ctx.beginPath();
        for(let x=Math.floor(config.xMin); x<=config.xMax; x++) { ctx.moveTo(mX(x),0); ctx.lineTo(mX(x),h); }
        for(let y=Math.floor(config.yMin); y<=config.yMax; y++) { ctx.moveTo(0,mY(y)); ctx.lineTo(w,mY(y)); }
        ctx.stroke();

        ctx.strokeStyle = '#ccc'; ctx.lineWidth = 2; ctx.beginPath();
        ctx.moveTo(0, mY(0)); ctx.lineTo(w, mY(0)); ctx.moveTo(mX(0), 0); ctx.lineTo(mX(0), h);
        ctx.stroke();

        let scope = getCombinedScope();
        ['fx', 'gx'].forEach(key => {
            if (!state.expr[key]) return;
            try {
                const compiled = math.compile(state.expr[key]);
                ctx.beginPath(); ctx.strokeStyle = (key==='fx'?'#0984e3':'#e17055'); ctx.lineWidth = 3;
                let first = true;
                for (let i = 0; i <= w; i += 2) {
                    let x = config.xMin + (i/w)*(config.xMax-config.xMin);
                    let y = compiled.evaluate({x:x, ...scope});
                    if (typeof y === 'number' && isFinite(y)) {
                        let py = mY(y);
                        if (first) { ctx.moveTo(i, py); first = false; } else { ctx.lineTo(i, py); }
                    } else { first = true; }
                }
                ctx.stroke();
            } catch(e) {}
        });
    }

    // 交互修复
    canvas.onmousedown = (e) => { isDragging = true; lastMousePos = { x: e.clientX, y: e.clientY }; };
    window.onmouseup = () => isDragging = false;
    canvas.onmousemove = (e) => {
        if (!isDragging) return;
        const dx = e.clientX - lastMousePos.x; const dy = e.clientY - lastMousePos.y;
        lastMousePos = { x: e.clientX, y: e.clientY };
        const ux = (config.xMax - config.xMin) / (canvas.width / window.devicePixelRatio);
        const uy = (config.yMax - config.yMin) / (canvas.height / window.devicePixelRatio);
        config.xMin -= dx * ux; config.xMax -= dx * ux;
        config.yMin += dy * uy; config.yMax += dy * uy;
        syncToUI(); drawGraph();
    };
    canvas.onwheel = (e) => {
        e.preventDefault();
        const factor = e.deltaY > 0 ? 1.1 : 0.9;
        const dx = (config.xMax - config.xMin) * (factor - 1);
        const dy = (config.yMax - config.yMin) * (factor - 1);
        config.xMin -= dx/2; config.xMax += dx/2;
        config.yMin -= dy/2; config.yMax += dy/2;
        syncToUI(); drawGraph();
    };

    function syncToUI() {
        document.getElementById('xMin').value = config.xMin.toFixed(2);
        document.getElementById('xMax').value = config.xMax.toFixed(2);
        document.getElementById('yMin').value = config.yMin.toFixed(2);
        document.getElementById('yMax').value = config.yMax.toFixed(2);
    }
    function syncFromInput() {
        config.xMin = parseFloat(document.getElementById('xMin').value);
        config.xMax = parseFloat(document.getElementById('xMax').value);
        config.yMin = parseFloat(document.getElementById('yMin').value);
        config.yMax = parseFloat(document.getElementById('yMax').value);
        drawGraph();
    }

    // --- 核心工具 ---
    function getCombinedScope() {
        let s = {};
        try {
            if (state.expr.fx) s.f = math.evaluate(`f(x) = ${state.expr.fx}`);
            if (state.expr.gx) s.g = math.evaluate(`g(x) = ${state.expr.gx}`);
        } catch(e) {}
        return s;
    }

    function renderLatex() {
        let str = currentExpression || (state.mode === 'main' ? "0" : "");
        let tex = "";
        try { tex = math.parse(str).toTex(); } catch(e) { tex = str; }
        if (state.mode === 'fx') tex = "f(x) = " + tex;
        if (state.mode === 'gx') tex = "g(x) = " + tex;
        katex.render(tex, singleDisplay, { displayMode: true, throwOnError: false });
    }

    function append(v) { currentExpression += (v==='Ans'?lastAnswer:v); renderLatex(); }
    function deleteLast() { currentExpression = currentExpression.slice(0,-1); renderLatex(); }
    function clearAll() { currentExpression = ''; renderLatex(); if(state.mode==='main') resVal.innerText='0'; }
    function calculate() {
        try {
            let res = math.evaluate(currentExpression, getCombinedScope());
            lastAnswer = math.format(res, {precision: 10});
            resVal.innerText = "= " + lastAnswer;
        } catch(e) { resVal.innerText = "Error"; }
    }
</script>
</body>
</html>